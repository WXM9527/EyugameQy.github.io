---
title: unity接入
author: xiaoming
date: 2021-04-07 17:00:00 +0800
categories: [Blogging, Tutorial]
tags: [unity,快速接入]
pin: true
---

# EyuUnitySdk

### 介绍
集成Eyu库SDK的UNITY项目，主要用于减少涉及对原生的处理
- 已接入
    - 国内Android：Topon(广告）,数数(统计)
    - 海外Android：Max(广告),Firebase(统计)
    - 国内iOS：Topon(广告),数数(统计)
- 待接入、测试
    - 海外iOS：Max(广告),Firebase(统计)

- 其他SDK
    - 已接入
        - 热云（已集成待测试）
        - AppFlyer（已集成待测试）
    - 待接入
        - 深度转换


### 使用的插件和涉及的文件夹
    - JsonDotNet（Plugins下JsonDotNet文件夹）
        - 可以更改 jsonutil 的实现来改用其他解析库，就可以移除该文件夹了
    - 涉及的文件夹：EyuSDK、Plugins、Resources
        - EyuSDK（集成的实现脚本）
        - Plugins(主要生成接入SDK需要的文件)   
        - Resources（目前通过res直接读取生成的部分配置）

### 注意事项
- 导入 EyuSDK.unitypackage 后,可能会出现 弹窗：api update required，请选择 No,Thanks。因为选择 Go Ahead 后可能会出现不可预测的问题。

### 集成流程
0. 需要下载并解压出 文件夹：‘EyuSDKFile’ (重要：不需导入unity)
1. 把 EyuSDK 的 Package 导入 Unity
2. 打开编辑器菜单中的 ‘EyuSDK’ 菜单，选择‘EyuSDk集成面板’
3. （基础配置处理）EyuSDk集成面板 - 完善SDK基础配置
    - （可选）输入app 基础信息
    - （可选）选择 广告 SDK
    - （可选）选择 统计 SDK
    - （可选）其他SDK
4. 填写好配置之后，点击 保存按钮
    - 配置文件 'EYU_INIT_CONFIG_ANDROID' 输出到 Resources 文件夹下
5. （广告配置处理）EyuSDk集成面板 - 完善广告配置
    - 广告配置涉及三个json，缓存设置，广告位设置 和 key设置
    - 这三个'配置文件' 一般由运营提供
    - 一般只需要调整新增广告位
    - 建议直接把'配置文件'放入 Resources/AdConfig 路径下，再用Import导入
    - Resources 路径下的'配置文件'Import后可以移除
6. 填写好配置之后，点击 保存按钮
    - 配置文件 'EYU_AD_CONFIG_ANDROID' 输出到 Resources 文件夹下
7. （重要）EyuSDk集成面板 - 选择SDK文件夹路径
    - 这个文件夹就是下载的压缩包解压后的文件夹，也就是存放EyuSDK.unitypackage 的文件夹
    - 因为有不少文件不需要也不能直接引入，所以要放在项目之外
    - 选择文件夹后，才会出现 ‘开始集成’ 按钮
    - 点击 ‘开始集成’ 按钮，注意控制台输出
8. 不同平台还有不同的处理，详情请看文档接下来的部分

### 关于Android
一、打包流程      
- (重要)打包的时候请选择 21 及以上的 API LEVEL
- 使用了自定义的 Gradle 和 AndroidManifest
    - （操作）设置：BuildSettings -> PlayerSettings -> publishingSettings => Build,集成完成后会自动勾选所有
    - 放置目录： Assets/Plugins/Android
    - [文档：Gradle](https://docs.unity3d.com/cn/2021.1/Manual/android-gradle-overview.html)
    - [文档：AndroidManifest](https://docs.unity3d.com/cn/2021.1/Manual/android-manifest.html)
- 使用了自定的 Activity
    - [文档：扩展 UnityPlayerActivity Java 代码](https://docs.unity3d.com/cn/2021.1/Manual/AndroidUnityPlayerActivity.html)
    - 如果已经有了定制，补充代码即可，无需使用该插件提供的 Activity 文件
    - 需要补充的代码如下:
        
        ```
        public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) {
                super.onRequestPermissionsResult(requestCode, permissions, grantResults);
                SdkCompat.getInstance().onRequestPermissionsResult(this, requestCode, permissions, grantResults);
        }
        ```



### 关于iOS
一、打包流程
> 0. 你需要知道一个工具：[CocoaPod](https://guides.cocoapods.org/using/getting-started.html)，并且在你的mac上安装该工具。
> 1. 通过unity导出Xcode工程
> 2. 对导出的工程新建终端，在终端里运行 pod update，并留意执行是否有警告或者报错
> 3. 打开当前工程目录下的 Unity-iPhone.xcworkspace 文件
> 4. 在 Targets 的 UnityFramework 的 Build Settings 中搜索‘GCC_PREPROCESSOR_DEFINITIONS’设置;找到 Preprocessor Macros 并根据所接入的模块添加相应配置; [在此网站查看所需配置](https://eyugameqy.github.io/posts/IOS-sdk%E6%8E%A5%E5%85%A5%E6%96%87%E6%A1%A3(cocoapods)/)
> 5. 最后走正常打包流程即可


### 如何使用
一、初始化
```
    // 建议在首个场景的Awake进行初始化
    NativeMgr.Init();
```


二、 广告
```

    // 可使用的接口 可以查看 AdMgr.cs
    // 注意：如果广告配置没有广告位(adPlaceId)，则无任何回调

    // 如果在配置里面设置了自动缓存 则可以不调用广告加载
    // 激励广告 - 加载
    AdMgr.INSTANCE.LoadRewardAd(string adPlaceId, (listener, type) =>
    {
        switch (type)
        {
            case AdEventType.ON_AD_LOADED:
                // do something on ad load success
                break;
        }
    });

    // 激励广告 - 展示
    AdMgr.INSTANCE.ShowRewardAd(string adPlaceId, (listener, type) =>
    {
        switch (type)
        {
            case AdEventType.ON_AD_REWARDED:
                // do something on ad reward
                break;
        }
    });

    // banner - 展示
    AdMgr.INSTANCE.ShowBannerAd(string adPlaceId,(listener, type) =>{});

    // banner - 隐藏
    AdMgr.INSTANCE.HideBannerAd(string adPlaceId,(listener, type) =>{});

    // 设置banner自动刷新 - 默认60s
    AdMgr.INSTANCE.StartBannerAutoRefresh(adPlaceId, 60);

    // 关闭banner自动刷新
    AdMgr.INSTANCE.StopBannerAutoRefresh();

    //... 其他逻辑大同小异 详细请看 AdMgr 内部实现 和 相关接口

```

三、 事件
```
    // 接口详细作用可以查看需要接入的SDK的官方文档
    // 可使用的接口 可以查看 EventMgr.cs
    // 接口暂时来说并不齐全，只接入了常见常用的接口，后续更新

    // 普通事件上报
    EventMgr.INSTANCE.LogEvent(string eventName, Dictionary<string, object> msg);
    EventMgr.INSTANCE.LogEvent(string eventName, string msg);

    // 用户属性（firebase暂时没有）
    EventMgr.INSTANCE.user_set(string key, object value);
    EventMgr.INSTANCE.user_setOnce(string key, object value);
    EventMgr.INSTANCE.user_add(string key, int value)
    EventMgr.INSTANCE.user_append(string key, object value)
    EventMgr.INSTANCE.user_unset(string[] key)
    EventMgr.INSTANCE.user_delete()
```


### 常见问题
- 请先看 ‘注意事项’
- 打包报错：android打包的 api level 需要大于 21，在Build Setting -> Player Setting -> Other Setting 中可以设置。
- 配置不对也无法展示广告，请重复确认包名，确认配置。
